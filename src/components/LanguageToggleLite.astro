---
const options = [
  { value: 'es', label: 'ES' },
  { value: 'en', label: 'EN' }
]
---

<label class='inline-flex items-center gap-1 text-xs text-muted-foreground'>
  <span class='sr-only'>Idioma</span>
  <select
    class='rounded-md border px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 bg-background'
    aria-label='Seleccionar idioma'
    data-lang-select
  >
    {options.map(opt => (
      <option value={opt.value}>{opt.label}</option>
    ))}
  </select>
</label>

<script>
  const LANG_KEY = 'language'
  const setLang = (lang) => {
    localStorage.setItem(LANG_KEY, lang)
    document.documentElement.setAttribute('lang', lang)
    document.querySelectorAll('[data-lang-content]').forEach(node => {
      const target = node.getAttribute('data-lang-content')
      node.classList.toggle('hidden', target !== lang)
    })
    document.querySelectorAll('[data-i18n-key]').forEach(node => {
      const key = node.getAttribute('data-i18n-key')
      const text = window.portfolioTranslations?.[lang]?.[key]
      if (text) node.textContent = text
    })
    window.dispatchEvent(new CustomEvent('languageChange', { detail: { language: lang } }))
  }

  const init = () => {
    const saved = localStorage.getItem(LANG_KEY) || 'es'
    setLang(saved)
    const select = document.querySelector('select[data-lang-select]')
    if (select) {
      select.value = saved
    }
  }

  document.addEventListener('change', (e) => {
    const select = (e.target as HTMLSelectElement)
    if (!select || select.tagName.toLowerCase() !== 'select' || !select.hasAttribute('data-lang-select')) return
    const lang = select.value || 'es'
    setLang(lang)
  })

  init()
</script>
