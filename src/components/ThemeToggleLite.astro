---
const options = [
  { value: 'light', label: 'Light' },
  { value: 'dark', label: 'Dark' },
  { value: 'system', label: 'System' }
]
---

<label class='inline-flex items-center gap-1 text-xs text-muted-foreground'>
  <span class='sr-only'>Tema</span>
  <select
    class='rounded-md border px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 bg-background'
    aria-label='Seleccionar tema'
    data-theme-select
  >
    {options.map(opt => (
      <option value={opt.value}>{opt.label}</option>
    ))}
  </select>
</label>

<script>
  const THEME_KEY = 'theme'

  const applyTheme = (mode) => {
    const root = document.documentElement
    const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches
    const resolved = mode === 'system' ? (systemPrefersDark ? 'dark' : 'light') : mode
    root.classList.toggle('dark', resolved === 'dark')
    localStorage.setItem(THEME_KEY, mode)
  }

  const init = () => {
    const saved = localStorage.getItem(THEME_KEY) || 'system'
    applyTheme(saved)
    const select = document.querySelector('select[data-theme-select]')
    if (select) select.value = saved
  }

  document.addEventListener('change', (e) => {
    const select = (e.target as HTMLSelectElement)
    if (!select || select.tagName.toLowerCase() !== 'select' || !select.hasAttribute('data-theme-select')) return
    const mode = select.value || 'system'
    applyTheme(mode)
  })

  init()
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
    const saved = localStorage.getItem(THEME_KEY) || 'system'
    if (saved === 'system') {
      applyTheme(saved)
      const select = document.querySelector('select[data-theme-select]')
      if (select) select.value = saved
    }
  })
</script>
